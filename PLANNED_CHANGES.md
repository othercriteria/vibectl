# Planned Changes for feature/plugin-system

## Overview
Implement a plugin system that allows users to replace default prompts with custom ones, providing extensibility and customization capabilities.

## Core Requirements
- [x] User can replace default prompts with custom prompts âœ…
- [x] Configurable via config options âœ…
- [x] Plugin management via `vibectl install plugin plugin-foo-v3.json` âœ…
- [x] Precedence order support like `["plugin-foo-v3", "plugin-foo-v2", "plugin-bar-v3"]` âœ… (COMPLETED)
- [x] Version compatibility checking for plugins (install time) âœ… **RECENTLY COMPLETED**
- [ ] Version compatibility checking for plugins (runtime validation)
- [x] WARNING level logging for command failures attributable to custom prompts âœ…

## Implementation Components

### 1. Plugin Management System âœ… COMPLETED
- [x] Plugin installation command: `vibectl install plugin <plugin-file>` âœ…
- [x] Plugin file format (JSON) with metadata and prompt definitions âœ…
- [x] Plugin storage location: `~/.config/vibectl/plugins/` âœ…
- [x] Plugin listing capabilities: `vibectl plugin list` âœ…
- [x] Plugin uninstallation and update capabilities âœ… **IMPLEMENTED**
- [x] Local file installation support (examples/plugins/ as step 0) âœ…
- [x] Plugin validation before storing (install-time courtesy check) âœ…

### 2. Prompt Store (MVP: File-based) âœ… COMPLETED
- [x] File-based prompt store for MVP âœ…
- [x] JSON file storage and management in `~/.config/vibectl/` âœ…
- [x] Prompt resolution with fallback chain using flat keys âœ…
- [x] Version compatibility validation at install time âœ… **RECENTLY COMPLETED**
- [ ] Version compatibility validation at runtime
- [x] Flat prompt key mapping (e.g., `"patch_resource_summary"`) âœ…

### 3. Configuration Integration âœ… COMPLETED
- [x] Plugin precedence configuration system âœ… (COMPLETED)
- [x] Integration with existing vibectl config system âœ…
- [x] Runtime prompt replacement mechanism âœ…
- [x] Plugin precedence CLI commands (`vibectl plugin precedence list/set/add/remove`) âœ…

### 4. Error Handling and Logging âœ… COMPLETED
- [x] Attribution tracking for custom prompt usage âœ…
- [x] WARNING level logging for custom prompt failures âœ…
- [x] Graceful fallback to default prompts on errors âœ…

## âœ… COMPLETED: MVP Implementation + Plugin Precedence + Version Compatibility

### âœ… Phase 1: Core Infrastructure & Examples
1. [x] Create `examples/plugins/` directory with sample plugin files âœ…
2. [x] Design JSON plugin file format specification âœ…
3. [x] Implement file-based prompt storage in `~/.config/vibectl/plugins/` âœ…
4. [x] Create basic plugin installation command with validation âœ…
5. [x] Add configuration support for plugin precedence âœ…

### âœ… Phase 2: Prompt Integration
1. [x] Define flat prompt key mapping strategy (e.g., `"patch_resource_summary"`) âœ…
2. [x] Start with `patch_resource_prompt` as proof of concept âœ…
3. [x] Implement prompt resolution and replacement mechanism âœ…
4. [x] Add error attribution and logging âœ…
5. [x] Test with sample plugin from examples/ âœ…

### âœ… Phase 3: Plugin Precedence System (COMPLETED)
1. [x] Add plugin precedence management commands âœ…
2. [x] Implement explicit precedence configuration âœ…
3. [x] Fix config system list handling bug âœ…
4. [x] Fix asyncclick import compatibility issue âœ…
5. [x] Complete plugin precedence CLI interface âœ…

### âœ… Phase 4: Version Compatibility System (RECENTLY COMPLETED)
1. [x] Implement semantic versioning support with operators (>=, <=, >, <, ==, !=) âœ…
2. [x] Add install-time version compatibility checking âœ…
3. [x] Create comprehensive version parsing and comparison logic âœ…
4. [x] Integrate version validation into plugin installation process âœ…
5. [x] Add 19 comprehensive test cases covering all version scenarios âœ…

### ðŸš§ Phase 5: Management & Polish (REMAINING)
1. [x] Add plugin management commands (uninstall, update) âœ… **IMPLEMENTED** - list was already done âœ…
2. [ ] Add runtime version compatibility validation
3. [ ] Extend to other prompt-using subcommands (patch working âœ…)
4. [ ] Comprehensive testing and documentation
5. [ ] Performance optimization

## âœ… RECENTLY COMPLETED FIXES

### Version Compatibility System âœ… (RECENTLY COMPLETED)
**Status**: INSTALL-TIME CHECKING FULLY IMPLEMENTED
- **Implemented**: `vibectl/version_compat.py` module with comprehensive version handling
- **Implemented**: Semantic versioning support with operators: `>=`, `<=`, `>`, `<`, `==`, `!=`
- **Implemented**: Version parsing for variable-length versions (1.0, 1.0.0, 1.2.3.4)
- **Implemented**: Version normalization for different-length version comparisons
- **Implemented**: Integration with `PluginStore._validate_plugin()` for install-time checks
- **Implemented**: 19 comprehensive test cases covering all functionality
- **Working**: Install-time validation prevents incompatible plugin installation
- **Current Version**: Validates against vibectl 0.8.7

### Plugin Precedence Configuration System âœ… (COMPLETED)
**Status**: FULLY IMPLEMENTED AND WORKING
- **Fixed**: Config system list handling bug where list values were stored as individual characters
- **Fixed**: AsyncClick import compatibility issue in plugin_cmd.py
- **Implemented**: Complete CLI interface for precedence management:
  - `vibectl plugin precedence list` - show current precedence order
  - `vibectl plugin precedence set plugin1 plugin2 ...` - set precedence order
  - `vibectl plugin precedence add plugin [--position N]` - add plugin to precedence
  - `vibectl plugin precedence remove plugin` - remove plugin from precedence
- **Working**: Explicit precedence configuration via `plugin_precedence` config key
- **Working**: Ordered resolution respects configured precedence

### Technical Fixes Applied
1. **Config System List Handling**: Fixed `Config.set()` method to properly handle list types without converting them to string representations first
2. **AsyncClick Compatibility**: Updated plugin_cmd.py to use `import asyncclick as click` to match the main CLI pattern
3. **Type Conversion**: Added `_convert_to_list()` method to properly parse list values from strings when needed
4. **Version Compatibility**: Added robust semantic versioning with comprehensive test coverage

## â“ Outstanding Questions

### Version Compatibility
**Status**: Install-time checking IMPLEMENTED âœ…, Runtime validation pending
- [x] Install-time version checking âœ… **RECENTLY COMPLETED**
- [ ] Runtime version validation
- [x] Semantic versioning enforcement âœ… **RECENTLY COMPLETED**

## ðŸŽ‰ SUCCESS ACHIEVED
- [x] Users can install custom prompt plugins from examples/plugins/ âœ…
- [x] Custom prompts are used with proper precedence âœ… (working with explicit precedence)
- [x] Plugin precedence is fully configurable and manageable âœ…
- [x] Install-time version compatibility checking prevents incompatible plugins âœ… **NEW**
- [x] Failures are properly attributed and logged âœ…
- [x] System degrades gracefully to defaults âœ…
- [x] No performance impact on non-plugin users âœ…
- [x] Plugin management commands work reliably âœ… (install, list, uninstall, update, precedence management working)

## Next Steps
1. **Add runtime version compatibility validation**
2. **Extend to other subcommands** beyond patch
3. **Add comprehensive testing**

## Note on Implementation Status
The plugin system is now highly functional with both precedence management and install-time version compatibility checking. The original undefined behavior (where precedence depended on filesystem order) has been replaced with explicit configuration-based precedence that users can control via CLI commands. Version compatibility ensures only compatible plugins can be installed, preventing runtime errors from version mismatches.
