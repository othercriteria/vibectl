# vibectl-server ‚Ä¢ Kubernetes Demo Suite

Easily explore three certificate-management strategies for **vibectl-server** on Kubernetes.  All demos build the same Docker image and differ only in how TLS certificates are issued and renewed.

| Demo | TLS Source | Challenge Type | External Port 80? | Best For |
|------|------------|----------------|------------------|----------|
| **CA Demo** (`demo-ca.sh`) | Private, in-cluster CA | N/A | No | Air-gapped or internal clusters where you control trust |
| **ACME TLS-ALPN-01** (`demo-acme.sh`) | Pebble / Let's Encrypt | TLS-ALPN-01 on gRPC port | No | Public clusters without an HTTP load-balancer |
| **ACME HTTP-01** (`demo-acme-http.sh`) | Pebble / Let's Encrypt | HTTP-01 on port 80 | **Yes** | Environments that already expose port 80 or terminate TLS upstream |

---

## Prerequisites

1. **Kubernetes cluster** with `kubectl` context (kind, k3s, minikube, Docker Desktop, EKS, etc.).
2. **Docker Engine** for building the `vibectl-server:local` image.
3. **MetalLB** (or cloud LB) only for the HTTP-01 demo ‚Äì it needs a LoadBalancer Service on ports 80/443.

> **Tip ü™Ñ** Each script auto-detects the cluster type and imports the Docker image if needed.

---

## One-Command Quick Start

```bash
# From repository root ‚Äì pick ONE of the following:

./examples/manifests/vibectl-server/demo-ca.sh           # Private-CA workflow
./examples/manifests/vibectl-server/demo-acme.sh         # ACME via TLS-ALPN-01
./examples/manifests/vibectl-server/demo-acme-http.sh    # ACME via HTTP-01 (needs port 80)
```

Each script:

1. Builds (or reuses) `vibectl-server:local`.
2. Creates a dedicated namespace.
3. Deploys any helper services (Pebble, challenge side-cars).
4. Waits for vibectl-server to obtain certificates.
5. Prints connection details *and* saves a demo JWT to `/tmp`.

---

## Demo Details

### 1 ‚ñ™ CA Demo (`demo-ca.sh`)

* **Certificates:** Generated by an init-container that creates a private root CA and signs the server cert.
* **Security:** Ideal for internal traffic ‚Äì clients trust a small custom CA bundle.
* **Renewal:** Manual (init-container can be re-run or rotated via `vibectl-server ca renew`).
* **Namespace:** `vibectl-server-ca`
* **Clean-up:**

  ```bash
  kubectl delete ns vibectl-server-ca
  rm -f /tmp/vibectl-demo-ca-bundle.crt
  ```

### 2 ‚ñ™ ACME TLS-ALPN-01 Demo (`demo-acme.sh`)

* **Certificates:** Issued automatically by Pebble (or Let's Encrypt in prod) using TLS-ALPN-01.
* **Ports:** Only 443 (`NodePort` 30443 in kind/k3s).  No HTTP port needed.
* **Workflow:** An init-container requests a cert; the gRPC server multiplexes ACME challenges and normal traffic over the same TLS port.
* **Namespace:** `vibectl-server-acme`
* **Clean-up:**

  ```bash
  kubectl delete ns vibectl-server-acme
  rm -f /tmp/vibectl-demo-pebble-ca.crt
  ```

### 3 ‚ñ™ ACME HTTP-01 Demo (`demo-acme-http.sh`)

* **Certificates:** Same as above but validated via HTTP-01 on port 80.
* **Load Balancer:** Requires a Service of type `LoadBalancer`; the script waits for an external IP and leverages `nip.io` for dynamic DNS.
* **Namespace:** `vibectl-server-acme-http`
* **Clean-up:**

  ```bash
  kubectl delete ns vibectl-server-acme-http
  rm -f /tmp/vibectl-demo-pebble-ca-http.crt /tmp/vibectl-demo-token.jwt
  ```

---

## Common Features

* üèó **Single Docker build** reused across demos.
* üîê **JWT authentication** ‚Äì each script stores a ready-to-use token in `/tmp` and configures the vibectl client.
* üìà **Readiness checks & helpful logs** ‚Äì the scripts exit early with guidance if prerequisites are missing.

---

## Troubleshooting Cheat-Sheet

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| *Pebble pod Pending* | No storage-class on cluster | Edit `pebble.yaml` to use `emptyDir` or install a default storage-class |
| *Timeout waiting for LoadBalancer IP* (HTTP-01) | MetalLB/controller not ready | `kubectl -n metallb-system rollout status deployment/controller` |
| *ACME certificate not provisioned* | Pebble unreachable / DNS wrong | Verify Pebble service URL & ACME domains in `vibectl-server-acme-config` |
| *Connection test fails* | Client CA bundle or JWT token not set | Check the paths printed at script end and re-run `vibectl setup-proxy configure ‚Ä¶` |

---

## Extending the Demos

* Swap Pebble for **Let's Encrypt staging** by patching the `directory-url` in the ConfigMap.
* Replace `NodePort` with **Ingress/Nginx** and update the service accordingly.
* Wire metrics to Prometheus; each deployment exposes `/metrics` when enabled.

For deep-dive documentation see [`docs/llm-proxy-server.md`](../../../docs/llm-proxy-server.md) and the server roadmap in [`TODO-SERVER.md`](../../../TODO-SERVER.md).
